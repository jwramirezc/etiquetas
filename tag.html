<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTitle">Nueva Etiqueta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
</head>

<body>
    <div class="container py-4">
        <div id="alertContainer"></div>
        <section id="tagScreen">
            <h4 id="formHeader" class="mb-4">Nueva Etiqueta</h4>
            <div class="row">
                <div class="col-md-6">
                    <form id="tagForm">
                        <div class="mb-3">
                            <label for="tagName" class="form-label">Nombre de la etiqueta</label>
                            <input type="text" class="form-control" id="tagName" required />
                        </div>
                        <div class="mb-3">
                            <label for="tagColor" class="form-label">Color</label>
                            <input type="color" class="form-control form-control-color" id="tagColor" value="#000000"
                                title="Elige un color" />
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" id="submitBtn" class="btn btn-primary">Guardar etiqueta</button>
                            <a href="index.html" class="btn btn-secondary">Volver</a>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ========== Script para manejar creación/edición ========== -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ---------- Referencias a elementos del DOM ----------
            const pageTitle = document.getElementById('pageTitle');
            const formHeader = document.getElementById('formHeader');
            const submitBtn = document.getElementById('submitBtn');
            const tagForm = document.getElementById('tagForm');
            const alertContainer = document.getElementById('alertContainer');
            const tagNameInput = document.getElementById('tagName');
            const tagColorInput = document.getElementById('tagColor');

            // 1) Lectura del parámetro "tagId" de la URL:
            function getQueryParam(param) {
                const params = new URLSearchParams(window.location.search);
                return params.get(param);
            }
            const tagIdParam = getQueryParam('tagId');

            // 2) Carga de las etiquetas desde localStorage
            let tags = JSON.parse(localStorage.getItem('tags')) || [];

            if (tagIdParam) {
                // ----------- MODO EDICIÓN -----------
                // Busco la etiqueta con ese ID
                const tagToEdit = tags.find(t => String(t.id) === String(tagIdParam));
                if (tagToEdit) {
                    // Ajusto títulos y botones
                    pageTitle.textContent = 'Editar Etiqueta';
                    formHeader.textContent = 'Editar Etiqueta';
                    submitBtn.textContent = 'Actualizar etiqueta';

                    // Prefill del formulario
                    tagNameInput.value = tagToEdit.name;
                    tagColorInput.value = tagToEdit.color;
                } else {
                    // Si no la encuentra, muestro alerta y regreso a index luego de 2s
                    const alerta = document.createElement('div');
                    alerta.className = 'alert alert-danger';
                    alerta.textContent = 'Etiqueta no encontrada.';
                    alertContainer.appendChild(alerta);
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return; // Detengo la inicialización del formulario
                }

                // Intercepto el submit para actualizar
                tagForm.addEventListener('submit', (e) => {
                    e.preventDefault();

                    const nuevoNombre = tagNameInput.value.trim();
                    const nuevoColor = tagColorInput.value;

                    if (!nuevoNombre) {
                        const alerta = document.createElement('div');
                        alerta.className = 'alert alert-warning';
                        alerta.textContent = 'El nombre de la etiqueta no puede ir vacío.';
                        alertContainer.innerHTML = '';
                        alertContainer.appendChild(alerta);
                        return;
                    }

                    // Actualizo el objeto en el array
                    tagToEdit.name = nuevoNombre;
                    tagToEdit.color = nuevoColor;
                    localStorage.setItem('tags', JSON.stringify(tags));

                    // Redirijo a index.html
                    window.location.href = 'index.html';
                });

            } else {
                // ----------- MODO CREACIÓN -----------
                tagForm.addEventListener('submit', (e) => {
                    e.preventDefault();

                    const nombre = tagNameInput.value.trim();
                    const color = tagColorInput.value;

                    if (!nombre) {
                        const alerta = document.createElement('div');
                        alerta.className = 'alert alert-warning';
                        alerta.textContent = 'Debes escribir un nombre para la etiqueta.';
                        alertContainer.innerHTML = '';
                        alertContainer.appendChild(alerta);
                        return;
                    }

                    // Genero un ID nuevo (usando el mismo esquema que en app.js)
                    let nextId = parseInt(localStorage.getItem('lastTagId') || '10', 10) + 1;
                    localStorage.setItem('lastTagId', nextId);

                    const newTag = {
                        id: nextId,
                        name: nombre,
                        color: color
                    };
                    tags.push(newTag);
                    localStorage.setItem('tags', JSON.stringify(tags));

                    // Redirijo a index.html
                    window.location.href = 'index.html';
                });
            }
        });
    </script>

    <script src="app.js"></script>
</body>

</html>